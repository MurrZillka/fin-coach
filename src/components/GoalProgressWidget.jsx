// src/components/GoalProgressWidget.jsx
import React from 'react';
import useGoalsStore from '../stores/goalsStore'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ—Ä –¶–µ–ª–µ–π
import useBalanceStore from '../stores/balanceStore'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ—Ä –ë–∞–ª–∞–Ω—Å–∞
import Text from './ui/Text'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Text


export default function GoalProgressWidget() {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Å—Ç–æ—Ä–∞ –¶–µ–ª–µ–π
    const { currentGoal, currentGoalLoading } = useGoalsStore();
    // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å—Ç–∞—Ç—É—Å –µ–≥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Å—Ç–æ—Ä–∞ –ë–∞–ª–∞–Ω—Å–∞ (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º isLoading)
    const { balance, isLoading: isBalanceLoading } = useBalanceStore();

    // –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
    const isLoading = currentGoalLoading || isBalanceLoading;

    // --- –†–∞—Å—á–µ—Ç—ã –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
    let percentage = 0; // –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
    let remainingAmount = null; // –û—Å—Ç–∞–≤—à–∞—è—Å—è —Å—É–º–º–∞ –¥–æ —Ü–µ–ª–∏

    // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å,
    // –∏ —Ü–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å)
    if (currentGoal && typeof balance === 'number' && typeof currentGoal.amount === 'number' && currentGoal.amount > 0) {
        // –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞—è —á–∞—Å—Ç—å - —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ –æ–Ω >= 0)
        const achieved = balance >= 0 ? balance : 0;
        // –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è: (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ / —Ü–µ–ª—å) * 100. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 100%.
        percentage = Math.min((achieved / currentGoal.amount) * 100, 100);
        // –û—Å—Ç–∞–≤—à–∞—è—Å—è —Å—É–º–º–∞: —Ü–µ–ª—å - –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ. –ú–∏–Ω–∏–º—É–º 0.
        remainingAmount = Math.max(0, currentGoal.amount - achieved);
    }

    // --- –õ–æ–≥–∏–∫–∞ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¶–≤–µ—Ç–∞ –°–µ–≥–º–µ–Ω—Ç–æ–≤ (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è) ---
    const numSegments = 20; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –ø–æ–ª–æ—Å–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const segments = Array.from({ length: numSegments }); // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫—É–±–∏–∫–æ–≤

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSS –∫–ª–∞—Å—Å–∞ —Ü–≤–µ—Ç–∞ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞
    // –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –æ–±—â–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
    const getSegmentColorClass = (segmentIndex, totalPercentage) => {
        // –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ü—É —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ (–æ—Ç 0 –¥–æ 100)
        const segmentEndPercentage = ((segmentIndex + 1) / numSegments) * 100;

        if (totalPercentage >= segmentEndPercentage) {
            // –ï—Å–ª–∏ –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–≥ –∏–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª –∫–æ–Ω–µ—Ü —Å–µ–≥–º–µ–Ω—Ç–∞, –æ–Ω "–∑–∞–ø–æ–ª–Ω–µ–Ω".
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç.
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ—Ä–æ–≥–∞—Ö
            const barPercentagePoint = segmentEndPercentage; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–µ—Ü —Å–µ–≥–º–µ–Ω—Ç–∞ –∫–∞–∫ —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞ –¥–ª—è —Ü–≤–µ—Ç–∞

            if (barPercentagePoint <= 25) return 'bg-red-500';      // –ö—Ä–∞—Å–Ω—ã–π –¥–æ 25%
            if (barPercentagePoint <= 50) return 'bg-orange-500';   // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–æ 50%
            if (barPercentagePoint <= 75) return 'bg-yellow-500';   // –ñ–µ–ª—Ç—ã–π –¥–æ 75%
            if (barPercentagePoint <= 100) return 'bg-green-500';  // –ó–µ–ª–µ–Ω—ã–π –¥–æ 100%
            // –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç > 100, –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∑–µ–ª–µ–Ω—ã–µ (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º percentage)
            return 'bg-green-500';

        } else {
            // –°–µ–≥–º–µ–Ω—Ç –µ—â–µ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
            return 'bg-gray-300'; // –¶–≤–µ—Ç –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ (—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π)
        }

        // –î–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Ü–≤–µ—Ç–∞ (–∫—Ä–∞—Å–Ω—ã–π->–æ—Ä–∞–Ω–∂–µ–≤—ã–π->–∂–µ–ª—Ç—ã–π->–∑–µ–ª–µ–Ω—ã–π) –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å –±—ã –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        // –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ —Ü–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –≤—Ö–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç (0-100) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç hex-–∫–æ–¥ –∏–ª–∏ RGB —Ü–≤–µ—Ç.
    };

    // --- –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –í–∏–¥–∂–µ—Ç–∞ ---

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    if (isLoading) {
        return (
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –≤ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –∫–ª–∞—Å—Å—ã, —á—Ç–æ –±—ã–ª–∏ –≤ BalanceWidget)
            <div className="flex-shrink-0 w-1/3 text-right">
                <Text variant="body" className="text-secondary-600 italic">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–∏ –∏ –±–∞–ª–∞–Ω—Å–∞...
                </Text>
            </div>
        );
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏ –∏–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞
    if (!currentGoal || currentGoal.is_achieved) {
        return (
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏
            <div className="flex-shrink-0 w-1/3 text-right">
                <Text variant="body" className="text-secondary-600 italic">
                    {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∞–∑–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ü–µ–ª–∏ –∏ –µ–µ —Å—Ç–∞—Ç—É—Å–∞ */}
                    {currentGoal ? '–¢–µ–∫—É—â–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!' : '–¢–µ–∫—É—â–∞—è —Ü–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.'}
                </Text>
            </div>
        );
    }

    // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –í–∏–¥–∂–µ—Ç–∞ –ü—Ä–æ–≥—Ä–µ—Å—Å–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è, –Ω–µ–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞—è —Ü–µ–ª—å ---

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à—É—é—Å—è —Å—É–º–º—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const formattedRemainingAmount = typeof remainingAmount === 'number'
        ? remainingAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : '--.--';

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–∫—Ä—É–≥–ª—è–µ–º)
    const formattedPercentage = percentage.toFixed(0); // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

    return (
        // –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –∫–ª–∞—Å—Å—ã, —á—Ç–æ –±—ã–ª–∏ –≤ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–µ)
        // flex-col items-end: —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–ª–æ–Ω–∫—É –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
        <div className="flex-shrink-0 w-1/3 text-right flex flex-col items-end">

            {/* –¢–µ–∫—Å—Ç: –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ —Ü–µ–ª–∏ */}
            {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ remainingAmount > 0 */}
            {remainingAmount > 0 && (
                <Text variant="body" className="text-secondary-800 mb-1"> {/* mb-1: –Ω–µ–±–æ–ª—å—à–æ–π –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø */}
                    –î–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å: {formattedRemainingAmount} ‚ÇΩ
                </Text>
            )}
            {/* –¢–µ–∫—Å—Ç: –ï—Å–ª–∏ —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∞ (—Ö–æ—Ç—è —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è !is_achieved) */}
            {/* –≠—Ç–æ—Ç –±–ª–æ–∫, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ –±—É–¥–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∑–¥–µ—Å—å, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –µ–≥–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã */}
            {remainingAmount <= 0 && percentage >= 100 && !currentGoal.is_achieved && (
                <Text variant="body" className="text-green-700 mb-1 font-semibold">
                    –ü–æ—á—Ç–∏ —É —Ü–µ–ª–∏! üéâ (100%+)
                </Text>
            )}

            {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ü–æ–ª–æ—Å—ã –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤ */}
            {/* items-center: –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ–ª–æ—Å—É –∏ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */}
            <div className="w-full flex items-center">
                {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ü–æ–ª–æ—Å—ã –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ */}
                {/* flex-grow: –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ —à–∏—Ä–∏–Ω–µ */}
                {/* h-4: –≤—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã, bg-gray-300: —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏, rounded: —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */}
                {/* overflow-hidden: –æ–±—Ä–µ–∑–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–º —É–≥–ª–∞–º */}
                {/* mr-2: –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø –æ—Ç –ø–æ–ª–æ—Å—ã –¥–æ —Ç–µ–∫—Å—Ç–∞ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ */}
                <div className="flex-grow flex h-4 bg-gray-300 rounded overflow-hidden mr-2">
                    {/* –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ–ª–æ—Å—ã */}
                    {segments.map((_, index) => (
                        <div
                            key={index} // –ö–ª—é—á –¥–ª—è React —Å–ø–∏—Å–∫–∞
                            // h-full: –≤—ã—Å–æ—Ç–∞ 100% —Ä–æ–¥–∏—Ç–µ–ª—è, flex-grow: –∑–∞–Ω–∏–º–∞–µ—Ç —Ä–∞–≤–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ,
                            // border-r border-white: —Ä–∏—Å—É–µ—Ç –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É –±–µ–ª–æ–≥–æ —Ü–≤–µ—Ç–∞ –º–µ–∂–¥—É —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏
                            // last:border-r-0: —É–±–∏—Ä–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—É —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                            // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞—Å—Å —Ü–≤–µ—Ç–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                            className={`h-full flex-grow border-r border-white last:border-r-0 ${getSegmentColorClass(index, percentage)}`}
                            // flexBasis: –∑–∞–¥–∞–µ–º –±–∞–∑–æ–≤—É—é —à–∏—Ä–∏–Ω—É –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –∫–∞–∫ —Ä–∞–≤–Ω—É—é –¥–æ–ª—é –æ—Ç 100%
                            style={{ flexBasis: `${100 / numSegments}%` }}
                        ></div>
                    ))}
                </div>

                {/* –¢–µ–∫—Å—Ç —Å –ü—Ä–æ—Ü–µ–Ω—Ç–æ–º –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */}
                <Text variant="body" className="text-secondary-800 font-semibold">{formattedPercentage}%</Text>
            </div>
        </div>
    );
}